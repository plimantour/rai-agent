<div id="main-content" hx-target="this" hx-swap="outerHTML">
    {% if messages %}
    <div class="toast-payload" data-messages='{{ messages | tojson | safe }}'></div>
    {% endif %}

    <section class="panel">
        <h2>Usage Guidance</h2>
        <p class="muted">Upload a detailed solution description to generate a draft Responsible AI assessment. This tool is intended for trained Microsoft RAI champions—review all AI-generated content before submission.</p>
        <p class="muted small">Adjust feature preferences and admin controls from the Settings modal in the header.</p>
    </section>

    <section class="panel">
        <h3>Solution description</h3>
        <form id="solution-form" class="stack" data-has-upload="{{ 'true' if session.stored_solution_text else 'false' }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <label for="solution_file">Upload or replace the solution description</label>
            <input type="file" id="solution_file" name="file" accept=".docx,.pdf,.txt,.json"
                   hx-post="/upload" hx-trigger="change" hx-target="#main-content" hx-swap="outerHTML" hx-encoding="multipart/form-data">
            {% if session.stored_solution_text %}
            <div class="stored-upload" id="stored-solution">
                <span class="file-name">{{ session.stored_solution_filename or "Stored solution description" }}</span>
                <button type="button" class="icon-button" hx-post="/upload/clear" hx-target="#main-content" hx-swap="outerHTML" aria-label="Clear stored solution description">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M9 3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1h5a1 1 0 1 1 0 2h-1v15a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V5H4a1 1 0 1 1 0-2h5zm9 2H6v15a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1V5zm-8 3a1 1 0 0 1 .993.883L11 9v8a1 1 0 0 1-1.993.117L9 17V9a1 1 0 0 1 1-1zm4 0a1 1 0 0 1 .993.883L15 9v8a1 1 0 0 1-1.993.117L13 17V9a1 1 0 0 1 1-1z"/></svg>
                </button>
            </div>
            {% else %}
            <p class="muted small">Upload once to reuse the text for analysis and generation.</p>
            {% endif %}
            <div class="button-row">
                <button type="button" class="button requires-upload"
                        hx-post="/analysis" hx-target="#main-content" hx-swap="outerHTML"
                        hx-include="#solution-form" hx-encoding="multipart/form-data"
                        {% if not session.stored_solution_text %}disabled{% endif %}>Analyze</button>
                <button type="button" class="button primary requires-upload"
                        hx-post="/generate" hx-target="#main-content" hx-swap="outerHTML"
                        hx-include="#solution-form" hx-encoding="multipart/form-data"
                        {% if not session.stored_solution_text %}disabled{% endif %}>Generate</button>
            </div>
        </form>
        <p class="muted footnote">Processing typically takes 10–15 minutes depending on model selection and template size. Detailed costs are displayed after completion.</p>
    </section>

    {% include "htmx/partials/progress_feed.html" %}

    {% if analysis_result %}
    <section class="panel result">
        <h3>Solution Description Analysis</h3>
        <p><strong>Cost:</strong> €{{ '%.4f'|format(analysis_result.cost or 0) }}</p>
        <div class="scrollable">{{ analysis_result.html|safe }}</div>
        {% if analysis_result.reasoning_summary %}
        <details>
            <summary>Reasoning summary</summary>
            <pre>{{ analysis_result.reasoning_summary }}</pre>
        </details>
        {% endif %}
        <div class="button-row">
            <a class="button" href="/download/analysis" hx-boost="false">Download analysis DOCX</a>
        </div>
    </section>
    {% endif %}

    {% if generation_result %}
    <section class="panel result">
        <h3>Draft RAI Assessment</h3>
        <p>{{ generation_result.message }}</p>
        {% if generation_result.cost is not none %}
        <p><strong>Total cost:</strong> €{{ '%.4f'|format(generation_result.cost) }}</p>
        {% endif %}
        {% if generation_result.reasoning_summary %}
        <details>
            <summary>Reasoning summary</summary>
            <pre>{{ generation_result.reasoning_summary }}</pre>
        </details>
        {% endif %}
        {% if generation_result.steps %}
        <div class="progress-steps">
            <h4>Processing steps</h4>
            <div class="progress-list">
            {% for step in generation_result.steps %}
                {% if step.heading is defined %}
                <div class="progress-item">
                    <span class="step-heading">{{ step.heading }}</span>
                    {% if step.subtext %}
                    <p class="muted small step-detail">{{ step.subtext }}</p>
                    {% endif %}
                </div>
                {% else %}
                <div class="progress-item">
                    <span class="step-heading">{{ step }}</span>
                </div>
                {% endif %}
            {% endfor %}
            </div>
        </div>
        {% endif %}
        <div class="button-row">
            <a class="button" href="/download/rai-internal" hx-boost="false">Download internal draft</a>
            <a class="button" href="/download/rai-public" hx-boost="false">Download public draft</a>
            <a class="button" href="/download/rai-zip" hx-boost="false">Download both (ZIP)</a>
        </div>
    </section>
    {% endif %}
</div>
