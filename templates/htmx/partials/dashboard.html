<div id="main-content" hx-target="this" hx-swap="outerHTML">
    {% if messages %}
    <div class="toast-payload" data-messages='{{ messages | tojson | safe }}'></div>
    {% endif %}

    <section class="panel">
        <h2>Usage Guidance</h2>
        <p class="muted">Upload a detailed solution description to generate a draft Responsible AI assessment. This tool is intended for trained Microsoft RAI champions—review all AI-generated content before submission.</p>
        <p class="muted small">Adjust feature preferences and admin controls from the Settings modal in the header.</p>
    </section>

    {% if threat_findings %}
    <section class="panel threat-panel{% if threat_blocked %} is-blocked{% endif %}">
        <div class="threat-header">
            <h3>Threat Analysis</h3>
            {% if threat_blocked %}
            <span class="status-badge status-critical" role="status">Upload blocked</span>
            {% else %}
            <span class="status-badge status-clear" role="status">Cleared</span>
            {% endif %}
        </div>
        <p class="muted small">Latest security checks on the uploaded document.</p>
        <ul class="threat-list">
            {% for finding in threat_findings %}
            <li class="threat-item threat-{{ finding.severity | default('info') }}">
                <div class="threat-summary">{{ finding.summary }}</div>
                <p class="threat-source">Source: {{ finding.source }}</p>
                {% if finding.items %}
                <ul class="threat-detail-list">
                    {% for item in finding.items %}
                    <li>{{ item }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% if finding.pii_entities %}
                <form class="pii-remediation-form" hx-post="/upload/pii-remediate" hx-target="#main-content" hx-swap="outerHTML">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="pii-remediation-list">
                        {% for entity in finding.pii_entities %}
                        <div class="pii-remediation-item">
                            <div class="pii-remediation-label">
                                <span class="pii-detected-text">Detected '{{ entity.detected_text | e }}'</span>
                                <span class="pii-detected-meta">
                                    {{ entity.description }}
                                    {% if entity.occurrences and entity.occurrences > 1 %}
                                    · {{ entity.occurrences }} occurrences
                                    {% endif %}
                                </span>
                                {% if entity.suggested_replacement %}
                                <span class="pii-suggestion">Suggested anonymized value: {{ entity.suggested_replacement | e }}</span>
                                {% endif %}
                            </div>
                            <div class="pii-remediation-controls">
                                <input type="hidden" name="pii_original__{{ entity.id }}" value="{{ entity.raw_text | e }}">
                                <label class="sr-only" for="pii-input-{{ entity.id }}">Replacement for {{ entity.detected_text | e }}</label>
                                <input type="text" id="pii-input-{{ entity.id }}" name="pii_replacement__{{ entity.id }}" value="{{ entity.suggested_replacement | e }}" data-original="{{ entity.raw_text | e }}" data-suggested="{{ entity.suggested_replacement | e }}" placeholder="{{ entity.raw_text | e }}">
                                {% if entity.raw_text %}
                                <button type="button" class="button tertiary small pii-deanonymize" data-target="pii-input-{{ entity.id }}" title="Replace anonymized value with the detected text">Deanonymize</button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="pii-remediation-actions">
                        <button type="submit" class="button primary">Proceed with upload</button>
                    </div>
                </form>
                {% endif %}
                {% if finding.details %}
                <p class="threat-details">{{ finding.details }}</p>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </section>
    {% endif %}

    <section class="panel">
        <h3>Solution description</h3>
        <form id="solution-form" class="stack" data-has-upload="{{ 'true' if session.stored_solution_text else 'false' }}" data-has-stored="{{ 'true' if session.stored_solution_text else 'false' }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <label for="solution_file">Upload or replace the solution description</label>
            <div class="file-picker">
                <input type="file" id="solution_file" name="file" accept=".docx,.pdf,.txt,.json"
                       class="file-input sr-only"
                       hx-post="/upload" hx-trigger="change" hx-target="#main-content" hx-swap="outerHTML" hx-encoding="multipart/form-data">
                <label for="solution_file" class="button secondary file-trigger" data-file-trigger role="button" tabindex="0">Choose file</label>
                <span class="file-placeholder" data-file-placeholder data-default="No file chosen" data-stored="{{ session.stored_solution_filename or 'Stored solution description' if session.stored_solution_text else '' }}">
                    {% if session.stored_solution_text %}{% else %}No file chosen{% endif %}
                </span>
            </div>
            {% if session.stored_solution_text %}
            <div class="stored-upload" id="stored-solution">
                <div class="file-meta">
                    <span class="file-name">{{ session.stored_solution_filename or "Stored solution description" }}</span>
                    <span class="verified-badge" aria-label="Document verified">
                        <svg class="verified-icon" viewBox="0 0 24 24" role="presentation" aria-hidden="true">
                            <path d="M12 2.5a1 1 0 0 1 .71.29l1.65 1.65 2.22-.33a1 1 0 0 1 1.13.77l.5 2.2 2 1.16a1 1 0 0 1 .38 1.36l-1.1 2.1.84 2.12a1 1 0 0 1-.4 1.24l-2 1.2-.2 2.26a1 1 0 0 1-1.13.9l-2.23-.37-1.58 1.53a1 1 0 0 1-1.4 0l-1.59-1.53-2.23.37a1 1 0 0 1-1.13-.9l-.2-2.26-2-1.2a1 1 0 0 1-.4-1.24l.84-2.12-1.1-2.1a1 1 0 0 1 .38-1.36l2-1.16.5-2.2a1 1 0 0 1 1.13-.77l2.22.33 1.65-1.65A1 1 0 0 1 12 2.5zm3.68 7.57-4.78 4.78-2.58-2.58a.75.75 0 0 0-1.06 1.06l3.1 3.1a.75.75 0 0 0 1.06 0l5.31-5.31a.75.75 0 1 0-1.06-1.06z" />
                        </svg>
                        <span class="verified-text">Verified</span>
                    </span>
                </div>
                <button type="button" class="icon-button" hx-post="/upload/clear" hx-target="#main-content" hx-swap="outerHTML" aria-label="Clear stored solution description">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M9 3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1h5a1 1 0 1 1 0 2h-1v15a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V5H4a1 1 0 1 1 0-2h5zm9 2H6v15a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1V5zm-8 3a1 1 0 0 1 .993.883L11 9v8a1 1 0 0 1-1.993.117L9 17V9a1 1 0 0 1 1-1zm4 0a1 1 0 0 1 .993.883L15 9v8a1 1 0 0 1-1.993.117L13 17V9a1 1 0 0 1 1-1z"/></svg>
                </button>
            </div>
            {% else %}
            <p class="muted small">Upload once to reuse the text for analysis and generation.</p>
            {% endif %}
            <div class="button-row">
        <button type="button" class="button requires-upload"
            hx-post="/analysis" hx-target="#main-content" hx-swap="outerHTML"
            hx-include="#solution-form input[type='hidden']"
                        {% if not session.stored_solution_text %}disabled{% endif %}>Analyze</button>
        <button type="button" class="button primary requires-upload"
            hx-post="/generate" hx-target="#main-content" hx-swap="outerHTML"
            hx-include="#solution-form input[type='hidden']"
                        {% if not session.stored_solution_text %}disabled{% endif %}>Generate</button>
            </div>
        </form>
        <p class="muted footnote">Processing typically takes 10–15 minutes depending on model selection and template size. Detailed costs are displayed after completion.</p>
    </section>

    {% include "htmx/partials/progress_feed.html" %}

    {% if analysis_result %}
    <section class="panel result">
        <h3>Solution Description Analysis</h3>
        <p><strong>Cost:</strong> €{{ '%.4f'|format(analysis_result.cost or 0) }}</p>
        <div class="scrollable">{{ analysis_result.html|safe }}</div>
        {% if analysis_result.reasoning_summary %}
        <details>
            <summary>Reasoning summary</summary>
            <pre>{{ analysis_result.reasoning_summary }}</pre>
        </details>
        {% endif %}
        <div class="button-row">
            <a class="button" href="/download/analysis" hx-boost="false">Download analysis DOCX</a>
        </div>
    </section>
    {% endif %}

    {% if generation_result %}
    <section class="panel result">
        <h3>Draft RAI Assessment</h3>
        <p>{{ generation_result.message }}</p>
        {% if generation_result.cost is not none %}
        <p><strong>Total cost:</strong> €{{ '%.4f'|format(generation_result.cost) }}</p>
        {% endif %}
        {% if generation_result.reasoning_summary %}
        <details>
            <summary>Reasoning summary</summary>
            <pre>{{ generation_result.reasoning_summary }}</pre>
        </details>
        {% endif %}
        {% if generation_result.steps %}
        <div class="progress-steps">
            <h4>Processing steps</h4>
            <div class="progress-list">
            {% for step in generation_result.steps %}
                {% if step.heading is defined %}
                <div class="progress-item">
                    <span class="step-heading">{{ step.heading }}</span>
                    {% if step.subtext %}
                    <p class="muted small step-detail">{{ step.subtext }}</p>
                    {% endif %}
                </div>
                {% else %}
                <div class="progress-item">
                    <span class="step-heading">{{ step }}</span>
                </div>
                {% endif %}
            {% endfor %}
            </div>
        </div>
        {% endif %}
        <div class="button-row">
            <a class="button" href="/download/rai-internal" hx-boost="false">Download internal draft</a>
            <a class="button" href="/download/rai-public" hx-boost="false">Download public draft</a>
            <a class="button" href="/download/rai-zip" hx-boost="false">Download both (ZIP)</a>
        </div>
    </section>
    {% endif %}
</div>
